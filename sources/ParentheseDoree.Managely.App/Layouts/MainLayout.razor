@inherits LayoutComponentBase
@inject GoogleAuthService AuthService
@inject NavigationManager NavigationManager
@implements IDisposable

@if (_isAuthenticated)
{
    <div class="app-layout">
        @* Sidebar *@
        <aside class="sidebar @(_sidebarOpen ? "open" : "")">
            <div class="sidebar-header">
                <a href="" class="sidebar-brand">
                    <i class="bi bi-gem"></i>
                    <span class="brand-text">Managely</span>
                </a>
                <button class="btn-sidebar-close d-lg-none" @onclick="ToggleSidebar">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <NavLink class="sidebar-link" href="" Match="NavLinkMatch.All" @onclick="CloseSidebar">
                    <i class="bi bi-house"></i><span>Accueil</span>
                </NavLink>
                <NavLink class="sidebar-link" href="clients" @onclick="CloseSidebar">
                    <i class="bi bi-people"></i><span>Clients</span>
                </NavLink>
                <NavLink class="sidebar-link" href="passages" @onclick="CloseSidebar">
                    <i class="bi bi-calendar-check"></i><span>Passages</span>
                </NavLink>
                <NavLink class="sidebar-link" href="prestations" @onclick="CloseSidebar">
                    <i class="bi bi-scissors"></i><span>Prestations</span>
                </NavLink>
                <NavLink class="sidebar-link" href="produits" @onclick="CloseSidebar">
                    <i class="bi bi-box-seam"></i><span>Produits</span>
                </NavLink>
                <NavLink class="sidebar-link" href="cartes-cadeaux" @onclick="CloseSidebar">
                    <i class="bi bi-gift"></i><span>Cartes cadeaux</span>
                </NavLink>
                <NavLink class="sidebar-link" href="finance" @onclick="CloseSidebar">
                    <i class="bi bi-graph-up"></i><span>Finance</span>
                </NavLink>
                <NavLink class="sidebar-link" href="parametres" @onclick="CloseSidebar">
                    <i class="bi bi-gear"></i><span>Paramètres</span>
                </NavLink>
            </nav>

            <div class="sidebar-footer">
                <div class="d-flex align-items-center p-3">
                    @if (!string.IsNullOrEmpty(AuthService.CurrentUser?.Picture))
                    {
                        <img src="@AuthService.CurrentUser.Picture"
                             alt="@AuthService.CurrentUser.Name"
                             class="rounded-circle me-2"
                             style="width:32px;height:32px;object-fit:cover;"
                             referrerpolicy="no-referrer" />
                    }
                    <div class="flex-grow-1 small text-truncate">
                        <div class="fw-semibold text-white">@AuthService.CurrentUser?.GivenName</div>
                        <div class="text-white-50 small">
                            @(AuthService.CanWrite ? "Lecture/Écriture" : "Lecture seule")
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-light ms-2" @onclick="SignOutAsync" title="Déconnexion">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </div>
        </aside>

        @* Overlay mobile *@
        @if (_sidebarOpen)
        {
            <div class="sidebar-overlay d-lg-none" @onclick="CloseSidebar"></div>
        }

        @* Contenu principal *@
        <div class="main-content">
            <header class="main-header d-lg-none">
                <button class="btn btn-link text-dark" @onclick="ToggleSidebar">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <span class="fw-bold">Managely</span>
            </header>

            <main class="page-content">
                @Body
            </main>
        </div>
    </div>
}
else
{
    @Body
}

@code {
    private bool _sidebarOpen = false;
    private bool _isAuthenticated = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // S'abonner aux changements d'état d'authentification
            AuthService.OnAuthStateChanged += HandleAuthStateChanged;

            // Initialiser l'auth et restaurer la session
            await AuthService.InitializeAsync();

            // Mettre à jour l'état après restauration
            _isAuthenticated = AuthService.IsSignedIn && AuthService.CanRead;
            StateHasChanged();
        }
    }

    private void HandleAuthStateChanged(bool isSignedIn, Models.GoogleUser? user)
    {
        _isAuthenticated = isSignedIn && AuthService.CanRead;
        InvokeAsync(StateHasChanged);
    }

    private void ToggleSidebar() => _sidebarOpen = !_sidebarOpen;
    private void CloseSidebar() => _sidebarOpen = false;

    private async Task SignOutAsync()
    {
        await AuthService.SignOutAsync();
        _isAuthenticated = false;
        NavigationManager.NavigateTo("login", forceLoad: true);
    }

    public void Dispose()
    {
        AuthService.OnAuthStateChanged -= HandleAuthStateChanged;
    }
}
