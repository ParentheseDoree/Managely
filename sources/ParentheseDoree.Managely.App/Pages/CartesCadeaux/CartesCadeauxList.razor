@page "/cartes-cadeaux"
@inject CarteCadeauService CarteSvc
@inject ClientService ClientSvc
@inject GoogleAuthService AuthService
@inject NavigationManager Nav

<PageTitle>Cartes & Bons - Managely</PageTitle>

<div class="page-header">
    <div>
        <h1><i class="bi bi-wallet2 me-2"></i>Cartes & Bons</h1>
        <p>Cartes cadeaux, cartes fid√©lit√© et bons anniversaire</p>
    </div>
    @if (AuthService.CanWrite)
    {
        <button class="btn btn-gold" @onclick="ShowAdd">
            <i class="bi bi-plus-lg me-1"></i> Nouvelle carte cadeau
        </button>
    }
</div>

<AlertMessage Message="@_alert" Type="@_alertType" OnDismiss="() => _alert = string.Empty" />

@* Filtres *@
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <SearchBar Value="@_search" ValueChanged="OnSearch" Placeholder="Rechercher par client ou origine..." />
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted mb-0">Type</label>
                <select class="form-select form-select-sm" @bind="_filterType" @bind:after="Filter">
                    <option value="">Tous les types</option>
                    <option value="achat">üéÅ Cartes cadeaux</option>
                    <option value="fidelite">üéñÔ∏è Cartes fid√©lit√©</option>
                    <option value="bon_fidelite">üéÇ Bons anniversaire</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted mb-0">Statut</label>
                <select class="form-select form-select-sm" @bind="_filterStatut" @bind:after="Filter">
                    <option value="">Tous</option>
                    <option value="active">Actives</option>
                    <option value="utilisee">Utilis√©es</option>
                    <option value="expiree">Expir√©es</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted mb-0">&nbsp;</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" @bind="_hideInactives" @bind:after="Filter" />
                    <label class="form-check-label small">Masquer p√©rim√©es/utilis√©es</label>
                </div>
            </div>
            <div class="col-md-2 text-end">
                <button class="btn btn-outline-secondary btn-sm" @onclick="LoadAsync" disabled="@_loading">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualiser
                </button>
                <div class="small text-muted mt-1">@_filtered.Count r√©sultat(s)</div>
            </div>
        </div>
    </div>
</div>

@if (_loading) { <LoadingSpinner /> }
else if (_filtered.Count == 0)
{
    <div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>Aucune carte ou bon trouv√©.</div>
}
else
{
    @* ‚îÄ‚îÄ Cartes ACTIVES ‚îÄ‚îÄ *@
    if (_filteredActives.Count > 0)
    {
        <h5 class="mb-3 text-success"><i class="bi bi-check-circle-fill me-2"></i>Actives (@_filteredActives.Count)</h5>
        <div class="row g-3 mb-4">
            @foreach (var c in _filteredActives)
            {
                @RenderCard(c)
            }
        </div>
    }

    @* ‚îÄ‚îÄ Cartes UTILIS√âES ‚îÄ‚îÄ *@
    if (_filteredUtilisees.Count > 0)
    {
        <h5 class="mb-3 text-secondary"><i class="bi bi-check-all me-2"></i>Utilis√©es (@_filteredUtilisees.Count)</h5>
        <div class="row g-3 mb-4">
            @foreach (var c in _filteredUtilisees)
            {
                @RenderCard(c)
            }
        </div>
    }

    @* ‚îÄ‚îÄ Cartes EXPIR√âES ‚îÄ‚îÄ *@
    if (_filteredExpirees.Count > 0)
    {
        <h5 class="mb-3 text-danger"><i class="bi bi-x-circle-fill me-2"></i>Expir√©es (@_filteredExpirees.Count)</h5>
        <div class="row g-3 mb-4">
            @foreach (var c in _filteredExpirees)
            {
                @RenderCard(c)
            }
        </div>
    }
}

@* ‚îÄ‚îÄ Carte template ‚îÄ‚îÄ *@
@{ RenderFragment RenderCard(CarteCadeau c) => __builder =>
{
    <div class="col-md-6 col-lg-4">
        <div class="card border-0 shadow-sm h-100 @(c.StatutCalcule != "active" ? "opacity-75" : "")">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="badge @(TypeBadgeCss(c.Type))">
                        <i class="bi @(TypeIcon(c.Type)) me-1"></i>@TypeLabel(c.Type)
                    </span>
                    <span class="badge @(StatutBadgeCss(c.StatutCalcule))">
                        @(c.StatutCalcule switch { "active" => "Active", "utilisee" => "Utilis√©e", "expiree" => "Expir√©e", _ => c.StatutCalcule })
                    </span>
                </div>

                <div class="d-flex align-items-baseline gap-2 mb-1">
                    <h4 class="fw-bold text-gold mb-0">@c.SoldeRestant.ToString("N2") ‚Ç¨</h4>
                    @if (c.SoldeRestant != c.MontantInitial)
                    {
                        <small class="text-muted">/ @c.MontantInitial.ToString("N2") ‚Ç¨</small>
                    }
                </div>

                @if (c.SoldeRestant != c.MontantInitial && c.MontantInitial > 0)
                {
                    <div class="progress mb-2" style="height:5px;">
                        <div class="progress-bar @(c.StatutCalcule == "active" ? "bg-success" : "bg-secondary")"
                             style="width:@((c.SoldeRestant / c.MontantInitial * 100).ToString("N0"))%"></div>
                    </div>
                }

                <div class="small">
                    <div class="mb-1"><i class="bi bi-person me-1 text-muted"></i><strong>@GetClientNom(c.ClientGuid)</strong></div>
                    @if (!string.IsNullOrEmpty(c.Origine))
                    {
                        <div class="mb-1 text-muted"><i class="bi bi-tag me-1"></i>@c.Origine</div>
                    }
                    <div class="text-muted">
                        <i class="bi bi-calendar3 me-1"></i>@c.DateCreation
                        @if (!string.IsNullOrEmpty(c.DateExpiration))
                        {
                            <span> ‚Äî <i class="bi bi-hourglass-split me-1"></i>Exp. @c.DateExpiration</span>
                        }
                    </div>
                    @if (c.Type == "bon_fidelite" && c.StatutCalcule == "active")
                    {
                        <div class="mt-1 text-info small"><i class="bi bi-info-circle me-1"></i>Utilisable si prestations cabine &gt; 60 ‚Ç¨</div>
                    }
                </div>
            </div>
            @if (AuthService.CanWrite && c.StatutCalcule == "active" && c.SoldeRestant == c.MontantInitial)
            {
                <div class="card-footer bg-transparent border-0 text-end">
                    <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(c)" title="Supprimer">
                        <i class="bi bi-trash me-1"></i>Supprimer
                    </button>
                </div>
            }
        </div>
    </div>
}; }

@* ‚îÄ‚îÄ Modal cr√©ation ‚îÄ‚îÄ *@
@if (_showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color:rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gift me-2"></i>Nouvelle carte cadeau</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">Client <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="text" class="form-control"
                                       placeholder="Rechercher un client par nom, t√©l√©phone ou email..."
                                       value="@_modalClientSearchText"
                                       @oninput="OnModalClientSearch"
                                       @onfocus="() => _showModalClientDropdown = true" />
                                @if (!string.IsNullOrEmpty(_editing.ClientGuid))
                                {
                                    <button class="btn btn-sm position-absolute top-50 end-0 translate-middle-y me-2 text-muted"
                                            @onclick="ClearModalClient" style="z-index:5;">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                }
                                @if (_showModalClientDropdown && _modalClientsFiltered.Count > 0)
                                {
                                    <div class="dropdown-menu show w-100 shadow-sm" style="max-height:200px;overflow-y:auto;z-index:1050;">
                                        @foreach (var cl in _modalClientsFiltered.Take(15))
                                        {
                                            <button class="dropdown-item" @onclick="() => SelectModalClient(cl)">
                                                <strong>@cl.NomComplet</strong>
                                                @if (!string.IsNullOrEmpty(cl.NumeroTelephone))
                                                {
                                                    <small class="text-muted ms-2">@cl.NumeroTelephone</small>
                                                }
                                            </button>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Type de carte</label>
                            <select class="form-select" @bind="_editing.Type">
                                <option value="achat">üéÅ Carte cadeau (vendue)</option>
                                <option value="fidelite">üéñÔ∏è Carte fid√©lit√© (offerte)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Montant (‚Ç¨) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" @bind="_editing.MontantInitial" step="0.01" min="0" placeholder="0.00" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Date d'expiration</label>
                            <input type="text" class="form-control" @bind="_editing.DateExpiration" placeholder="JJ/MM/AAAA" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Origine / Description</label>
                            <input type="text" class="form-control" @bind="_editing.Origine" placeholder="Ex: Cadeau Noel" />
                        </div>
                    </div>
                    <div class="alert alert-info small mt-3 mb-0">
                        <i class="bi bi-lock me-1"></i>
                        Non modifiable apr√®s cr√©ation. Les bons anniversaire sont g√©n√©r√©s automatiquement.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">Annuler</button>
                    <button class="btn btn-gold" @onclick="SaveAsync" disabled="@_saving">
                        @if (_saving) { <span class="spinner-border spinner-border-sm me-1"></span> }
                        <i class="bi bi-check-lg me-1"></i> Cr√©er
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<ConfirmModal IsVisible="_showDelete" Title="Supprimer" TitleCss="text-danger" Icon="bi-exclamation-triangle"
              ConfirmText="Supprimer" IsProcessing="_deleting"
              OnConfirm="DeleteAsync" OnCancel="() => _showDelete = false">
    <p>Supprimer cette carte de @_toDelete?.MontantInitial.ToString("N2") ‚Ç¨ ?</p>
</ConfirmModal>

@code {
    private List<CarteCadeau> _all = [], _filtered = [];
    private List<CarteCadeau> _filteredActives => _filtered.Where(c => c.StatutCalcule == "active").ToList();
    private List<CarteCadeau> _filteredUtilisees => _filtered.Where(c => c.StatutCalcule == "utilisee").ToList();
    private List<CarteCadeau> _filteredExpirees => _filtered.Where(c => c.StatutCalcule == "expiree").ToList();
    private List<Client> _clients = [];
    private Dictionary<string, string> _clientNoms = new();
    private bool _loading = true, _showModal, _saving, _showDelete, _deleting;
    private bool _hideInactives = true; // Par d√©faut on masque les p√©rim√©es/utilis√©es
    private CarteCadeau _editing = new();
    private CarteCadeau? _toDelete;
    private string _search = "", _filterType = "", _filterStatut = "", _alert = "", _alertType = "info";
    private string _modalClientSearchText = "";
    private bool _showModalClientDropdown;
    private List<Client> _modalClientsFiltered = [];

    // Helpers d'affichage
    private static string TypeLabel(string type) => type switch
    {
        "achat" => "Carte cadeau", "fidelite" => "Carte fid√©lit√©",
        "bon_fidelite" => "Bon anniversaire", _ => type
    };
    private static string TypeIcon(string type) => type switch
    {
        "fidelite" => "bi-heart-fill", "bon_fidelite" => "bi-cake2-fill", _ => "bi-gift-fill"
    };
    private static string TypeBadgeCss(string type) => type switch
    {
        "fidelite" => "bg-warning text-dark", "bon_fidelite" => "bg-info text-white", _ => "bg-primary"
    };
    private static string StatutBadgeCss(string statut) => statut switch
    {
        "active" => "bg-success", "utilisee" => "bg-secondary", "expiree" => "bg-danger", _ => "bg-dark"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsSignedIn || !AuthService.CanRead) { Nav.NavigateTo("login"); return; }
            await LoadAsync();
        }
    }

    private async Task LoadAsync()
    {
        _loading = true; StateHasChanged();
        try
        {
            _all = await CarteSvc.GetAllAsync(true);
            _clients = await ClientSvc.GetAllAsync();
            _clientNoms = _clients.ToDictionary(c => c.Guid, c => c.NomComplet);
            Filter();
        }
        catch (Exception ex) { _alert = ex.Message; _alertType = "danger"; }
        finally { _loading = false; StateHasChanged(); }
    }

    private string GetClientNom(string guid) => _clientNoms.TryGetValue(guid, out var n) ? n : "‚Äî";
    private void OnSearch(string val) { _search = val; Filter(); StateHasChanged(); }

    private void Filter()
    {
        var q = _all.AsEnumerable();

        // Masquer p√©rim√©es / utilis√©es si coch√©
        if (_hideInactives)
            q = q.Where(c => c.StatutCalcule == "active");

        if (!string.IsNullOrWhiteSpace(_search))
        {
            var t = Client.SupprimerAccents(_search.ToLower());
            q = q.Where(c => Client.SupprimerAccents(GetClientNom(c.ClientGuid)).Contains(t, StringComparison.OrdinalIgnoreCase)
                           || Client.SupprimerAccents(c.Origine).Contains(t, StringComparison.OrdinalIgnoreCase));
        }
        if (!string.IsNullOrEmpty(_filterType)) q = q.Where(c => c.Type == _filterType);
        if (!string.IsNullOrEmpty(_filterStatut)) q = q.Where(c => c.StatutCalcule == _filterStatut);

        // Tri : actives d'abord, puis par date de cr√©ation d√©croissante
        _filtered = q
            .OrderBy(c => c.StatutCalcule == "active" ? 0 : c.StatutCalcule == "utilisee" ? 1 : 2)
            .ThenByDescending(c => c.DateCreation)
            .ToList();
        StateHasChanged();
    }

    private void ShowAdd()
    {
        _editing = new CarteCadeau
        {
            Type = "achat",
            DateCreation = DateTime.Now.ToString("dd/MM/yyyy"),
            DateExpiration = DateTime.Now.AddYears(1).ToString("dd/MM/yyyy")
        };
        _modalClientSearchText = "";
        _modalClientsFiltered = [];
        _showModalClientDropdown = false;
        _showModal = true;
    }

    private void CloseModal() { _showModal = false; }
    private void ConfirmDelete(CarteCadeau c) { _toDelete = c; _showDelete = true; }

    private void OnModalClientSearch(ChangeEventArgs e)
    {
        _modalClientSearchText = e.Value?.ToString() ?? "";
        _showModalClientDropdown = true;
        if (string.IsNullOrWhiteSpace(_modalClientSearchText))
        {
            _modalClientsFiltered = _clients.Take(15).ToList();
            _editing.ClientGuid = "";
        }
        else
        {
            var t = Client.SupprimerAccents(_modalClientSearchText.ToLower());
            _modalClientsFiltered = _clients
                .Where(c => Client.SupprimerAccents(c.NomComplet).Contains(t, StringComparison.OrdinalIgnoreCase)
                    || c.NumeroTelephone.Contains(t, StringComparison.OrdinalIgnoreCase)
                    || Client.SupprimerAccents(c.Email).Contains(t, StringComparison.OrdinalIgnoreCase))
                .Take(15).ToList();
        }
    }

    private void SelectModalClient(Client c)
    {
        _editing.ClientGuid = c.Guid;
        _modalClientSearchText = c.NomComplet;
        _showModalClientDropdown = false;
    }

    private void ClearModalClient() { _editing.ClientGuid = ""; _modalClientSearchText = ""; }

    private async Task SaveAsync()
    {
        if (string.IsNullOrEmpty(_editing.ClientGuid)) { _alert = "Veuillez s√©lectionner un client."; _alertType = "warning"; return; }
        if (_editing.MontantInitial <= 0) { _alert = "Le montant doit √™tre sup√©rieur √† 0."; _alertType = "warning"; return; }
        _editing.SoldeRestant = _editing.MontantInitial;
        _saving = true; StateHasChanged();
        try
        {
            await CarteSvc.AddAsync(_editing);
            _alert = $"Carte de {_editing.MontantInitial:N2} ‚Ç¨ cr√©√©e."; _alertType = "success";
            CloseModal(); await LoadAsync();
        }
        catch (Exception ex) { _alert = ex.Message; _alertType = "danger"; }
        finally { _saving = false; StateHasChanged(); }
    }

    private async Task DeleteAsync()
    {
        if (_toDelete == null) return;
        _deleting = true; StateHasChanged();
        try
        {
            await CarteSvc.DeleteAsync(_toDelete.RowIndex);
            _alert = "Carte supprim√©e."; _alertType = "success";
            _showDelete = false; await LoadAsync();
        }
        catch (Exception ex) { _alert = ex.Message; _alertType = "danger"; }
        finally { _deleting = false; StateHasChanged(); }
    }
}
