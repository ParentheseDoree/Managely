@page "/passages/nouveau"
@page "/passages/{Guid}/modifier"
@inject PassageService PassageSvc
@inject ClientService ClientSvc
@inject PrestationService PrestaSvc
@inject ProduitService ProduitSvc
@inject CarteCadeauService CarteSvc
@inject FideliteService FideliteSvc
@inject MouvementStockService MouvementSvc
@inject GoogleAuthService AuthService
@inject ToastService Toast
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<PageTitle>@(_isEdit ? "Modifier" : "Nouveau") passage - Managely</PageTitle>

<div class="page-header">
    <div><h1><i class="bi bi-calendar-plus me-2"></i>@(_isEdit ? "Modifier le passage" : "Nouveau passage")</h1></div>
    <button class="btn btn-outline-secondary" @onclick="GoBack"><i class="bi bi-arrow-left me-1"></i> Retour</button>
</div>

<AlertMessage Message="@_alert" Type="@_alertType" OnDismiss="() => _alert = string.Empty" />

@if (_conflitDetecte)
{
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Conflit d√©tect√© !</strong> Ce passage a √©t√© modifi√© par un autre utilisateur.
        <div class="mt-2">
            <button class="btn btn-sm btn-outline-danger me-2" @onclick="ForcerSauvegarde">
                <i class="bi bi-save me-1"></i> Forcer l'√©criture
            </button>
            <button class="btn btn-sm btn-outline-primary" @onclick="RechargerDonnees">
                <i class="bi bi-arrow-clockwise me-1"></i> Recharger
            </button>
        </div>
    </div>
}

@if (_fideliteCarte != null)
{
    <div class="alert alert-success">
        <i class="bi bi-gift me-2"></i>
        <strong>Carte fid√©lit√© g√©n√©r√©e !</strong> Valeur : @_fideliteCarte.MontantInitial.ToString("N2") ‚Ç¨
        <br /><small class="text-muted">@_fideliteCarte.Origine</small>
    </div>
}

<div class="row g-4">
    @* Colonne gauche : infos principales *@
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header pt-3"><h5 class="mb-0">Informations du passage</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    @* S√©lection client avec recherche *@
                    <div class="col-md-6">
                        <label class="form-label">Client <span class="text-danger">*</span></label>
                        <div class="position-relative">
                            <input type="text" class="form-control @(string.IsNullOrEmpty(_passage.ClientGuid) && _triedSave ? "is-invalid" : "")"
                                   placeholder="Rechercher un client..."
                                   value="@_clientSearchText"
                                   @oninput="OnClientSearch"
                                   @onfocus="() => _showClientDropdown = true" />
                            @if (!string.IsNullOrEmpty(_passage.ClientGuid))
                            {
                                <button class="btn btn-sm position-absolute top-50 end-0 translate-middle-y me-2 text-muted"
                                        @onclick="ClearClient" style="z-index:5;">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            }
                            @if (_showClientDropdown && _clientsFiltered.Count > 0)
                            {
                                <div class="dropdown-menu show w-100 shadow-sm" style="max-height:250px;overflow-y:auto;z-index:1050;">
                                    @foreach (var c in _clientsFiltered.Take(20))
                                    {
                                        <button class="dropdown-item d-flex justify-content-between align-items-center"
                                                @onclick="() => SelectClient(c)">
                                            <span>
                                                <strong>@c.NomComplet</strong>
                                                @if (!string.IsNullOrEmpty(c.NumeroTelephone))
                                                {
                                                    <small class="text-muted ms-2">@c.NumeroTelephone</small>
                                                }
                                            </span>
                                        </button>
                                    }
                                </div>
                            }
                            @if (string.IsNullOrEmpty(_passage.ClientGuid) && _triedSave)
                            {
                                <div class="invalid-feedback">Veuillez s√©lectionner un client dans la liste.</div>
                            }
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date <span class="text-danger">*</span></label>
                        <input type="text" class="form-control @(string.IsNullOrEmpty(_passage.Date) && _triedSave ? "is-invalid" : "")"
                               @bind="_passage.Date" placeholder="JJ/MM/AAAA" />
                        @if (string.IsNullOrEmpty(_passage.Date) && _triedSave)
                        {
                            <div class="invalid-feedback">La date est requise.</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        @* Prestations *@
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header pt-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-scissors me-2 text-gold"></i>Prestations r√©alis√©es</h5>
                <button class="btn btn-sm btn-outline-gold" @onclick="AddPrestation"><i class="bi bi-plus"></i> Ajouter une prestation</button>
            </div>
            <div class="card-body">
                @if (_passage.Prestations.Count == 0 && _passage.ProduitsVendus.Count == 0 && _triedSave)
                {
                    <div class="alert alert-warning small py-2 mb-2">
                        <i class="bi bi-exclamation-triangle me-1"></i>Ajoutez au moins une prestation ou un produit vendu.
                    </div>
                }
                @if (_passage.Prestations.Count == 0)
                {
                    <p class="text-muted mb-0"><i class="bi bi-info-circle me-1"></i>Aucune prestation ajout√©e. Cliquez sur ¬´ Ajouter ¬ª pour s√©lectionner un soin du catalogue.</p>
                }
                @for (int i = 0; i < _passage.Prestations.Count; i++)
                {
                    var idx = i;
                    var pp = _passage.Prestations[idx];
                    <div class="row g-2 mb-2 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label small text-muted mb-0">Soin</label>
                            <select class="form-select form-select-sm @(string.IsNullOrEmpty(pp.PrestationId) && _triedSave ? "is-invalid" : "")"
                                    value="@pp.PrestationId" @onchange="(e) => OnPrestationSelected(idx, e)">
                                <option value="">-- Choisir un soin --</option>
                                @foreach (var p in _prestationsCatalogue)
                                {
                                    <option value="@p.Guid">@p.Nom (@p.PrixDefaut.ToString("N2") ‚Ç¨)</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-0">Prix (‚Ç¨)</label>
                            <input type="number" class="form-control form-control-sm" @bind="pp.Prix" step="0.01" placeholder="0.00" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-0">Dur√©e (min)</label>
                            <input type="number" class="form-control form-control-sm" @bind="pp.DureeMinutes" placeholder="0" />
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => _passage.Prestations.RemoveAt(idx)" title="Retirer"><i class="bi bi-x"></i></button>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Produits vendus *@
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header pt-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bag me-2 text-gold"></i>Produits vendus</h5>
                <button class="btn btn-sm btn-outline-gold" @onclick="AddProduitVendu"><i class="bi bi-plus"></i> Ajouter un produit</button>
            </div>
            <div class="card-body">
                @if (_passage.ProduitsVendus.Count == 0)
                {
                    <p class="text-muted mb-0"><i class="bi bi-info-circle me-1"></i>Aucun produit vendu lors de ce passage.</p>
                }
                @for (int i = 0; i < _passage.ProduitsVendus.Count; i++)
                {
                    var idx = i;
                    var pv = _passage.ProduitsVendus[idx];
                    var produitStock = _produitsCatalogue.FirstOrDefault(p => p.Guid == pv.ProduitId);
                    <div class="row g-2 mb-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label small text-muted mb-0">Produit</label>
                            <select class="form-select form-select-sm @(string.IsNullOrEmpty(pv.ProduitId) && _triedSave ? "is-invalid" : "")"
                                    value="@pv.ProduitId" @onchange="(e) => OnProduitVenduSelected(idx, e)">
                                <option value="">-- Choisir un produit --</option>
                                @foreach (var p in _produitsCatalogue)
                                {
                                    <option value="@p.Guid">@p.Nom (@p.PrixVente.ToString("N2") ‚Ç¨) [stock: @p.Stock]</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-0">Quantit√©</label>
                            <input type="number" class="form-control form-control-sm @(produitStock != null && pv.Quantite > produitStock.Stock ? "is-invalid" : "")"
                                   @bind="pv.Quantite" min="1" placeholder="1" />
                            @if (produitStock != null && pv.Quantite > produitStock.Stock)
                            {
                                <div class="invalid-feedback">Stock insuffisant (@produitStock.Stock dispo)</div>
                            }
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-0">Prix unit. (‚Ç¨)</label>
                            <input type="number" class="form-control form-control-sm" @bind="pv.PrixUnitaire" step="0.01" placeholder="0.00" />
                        </div>
                        <div class="col-md-2 text-end">
                            <label class="form-label small text-muted mb-0">Total</label>
                            <div class="fw-bold small">@pv.Total.ToString("N2") ‚Ç¨</div>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => _passage.ProduitsVendus.RemoveAt(idx)" title="Retirer"><i class="bi bi-x"></i></button>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Produits utilis√©s durant la prestation (d√©cr√©mente le stock, pas factur√©) *@
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header pt-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-droplet me-2 text-gold"></i>Produits utilis√©s (stock)</h5>
                <button class="btn btn-sm btn-outline-gold" @onclick="AddProduitUtilise"><i class="bi bi-plus"></i> Ajouter</button>
            </div>
            <div class="card-body">
                @if (_produitsUtilises.Count == 0)
                {
                    <p class="text-muted mb-0"><i class="bi bi-info-circle me-1"></i>Produits consomm√©s durant la prestation (non factur√©s, d√©cr√©ment√©s du stock).</p>
                }
                @for (int i = 0; i < _produitsUtilises.Count; i++)
                {
                    var idx = i;
                    var pu = _produitsUtilises[idx];
                    var puStock = _produitsCatalogue.FirstOrDefault(p => p.Guid == pu.ProduitId);
                    <div class="row g-2 mb-2 align-items-end">
                        <div class="col-md-6">
                            <label class="form-label small text-muted mb-0">Produit</label>
                            <select class="form-select form-select-sm" value="@pu.ProduitId"
                                    @onchange="(e) => OnProduitUtiliseSelected(idx, e)">
                                <option value="">-- Choisir --</option>
                                @foreach (var p in _produitsCatalogue)
                                {
                                    <option value="@p.Guid">@p.Nom (@p.Marque) [stock: @p.Stock]</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted mb-0">Quantit√©</label>
                            <input type="number" class="form-control form-control-sm @(puStock != null && pu.Quantite > puStock.Stock ? "is-invalid" : "")"
                                   @bind="pu.Quantite" min="1" />
                            @if (puStock != null && pu.Quantite > puStock.Stock)
                            {
                                <div class="invalid-feedback">Stock insuffisant</div>
                            }
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted mb-0">Stock</label>
                            <div class="small fw-bold">@(puStock?.Stock.ToString() ?? "‚Äî")</div>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => _produitsUtilises.RemoveAt(idx)"><i class="bi bi-x"></i></button>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Produits conseill√©s *@
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header pt-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-lightbulb me-2 text-gold"></i>Produits conseill√©s</h5>
                <button class="btn btn-sm btn-outline-gold" @onclick="AddProduitConseille"><i class="bi bi-plus"></i> Ajouter</button>
            </div>
            <div class="card-body">
                @if (_passage.ProduitsConseilles.Count == 0)
                {
                    <p class="text-muted mb-0">Aucun produit conseill√©.</p>
                }
                @for (int i = 0; i < _passage.ProduitsConseilles.Count; i++)
                {
                    var idx = i;
                    var pc = _passage.ProduitsConseilles[idx];
                    <div class="row g-2 mb-2 align-items-end">
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <select class="form-select form-select-sm" value="@pc.ProduitId"
                                        @onchange="(e) => OnProduitConseilleSelected(idx, e)"
                                        style="max-width:60%;">
                                    <option value="">-- Libre --</option>
                                    @foreach (var p in _produitsCatalogue)
                                    {
                                        <option value="@p.Guid">@p.Nom</option>
                                    }
                                </select>
                                @if (pc.EstTexteLibre)
                                {
                                    <input type="text" class="form-control form-control-sm" @bind="pc.Nom" placeholder="Nom libre..." />
                                }
                            </div>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm" @bind="pc.Commentaire" placeholder="Commentaire..." />
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => _passage.ProduitsConseilles.RemoveAt(idx)"><i class="bi bi-x"></i></button>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* Note interne *@
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header pt-3"><h5 class="mb-0"><i class="bi bi-journal-text me-2 text-gold"></i>Note interne</h5></div>
            <div class="card-body">
                <textarea class="form-control" rows="3" @bind="_passage.NoteInterne"
                          placeholder="Notes professionnelles (pr√©f√©rences, allergies, recommandations...)"></textarea>
            </div>
        </div>
    </div>

    @* Colonne droite : paiement + r√©capitulatif *@
    <div class="col-lg-4">
        @* Cartes & Bons disponibles pour ce client *@
        @if (_cartesClient.Count > 0)
        {
            <div class="card border-0 shadow-sm mb-4 border-start border-3 border-info">
                <div class="card-header pt-3"><h6 class="mb-0"><i class="bi bi-wallet2 me-2 text-info"></i>Cartes & Bons du client</h6></div>
                <div class="card-body p-2">
                    @foreach (var cc in _cartesClient)
                    {
                        <div class="d-flex justify-content-between align-items-center p-2 mb-1 bg-light rounded small">
                            <div>
                                <span class="badge @(cc.Type switch { "fidelite" => "bg-warning text-dark", "bon_fidelite" => "bg-info", _ => "bg-primary" }) me-1">
                                    @(cc.Type switch { "fidelite" => "Fid√©lit√©", "bon_fidelite" => "Bon Anniv.", _ => "Cadeau" })
                                </span>
                                @if (!string.IsNullOrEmpty(cc.Origine))
                                {
                                    <span class="text-muted">@cc.Origine</span>
                                }
                            </div>
                            <strong class="text-success">@cc.SoldeRestant.ToString("N2") ‚Ç¨</strong>
                        </div>
                    }
                </div>
            </div>
        }

        @* Paiement *@
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header pt-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Paiement</h5>
                <button class="btn btn-sm btn-outline-gold" @onclick="AddPaiement" title="Fractionner"><i class="bi bi-plus"></i> Fractionner</button>
            </div>
            <div class="card-body">
                @if (_passage.Paiements.Count == 0)
                {
                    <label class="form-label small fw-semibold">Mode de paiement <span class="text-danger">*</span></label>
                    <select class="form-select form-select-sm @(string.IsNullOrEmpty(_passage.ModePaiement) && _triedSave ? "is-invalid" : "")"
                            @bind="_passage.ModePaiement">
                        <option value="">-- S√©lectionner --</option>
                        <option value="CB">üí≥ Carte bancaire</option>
                        <option value="Esp√®ces">üíµ Esp√®ces</option>
                        <option value="Ch√®que">üìù Ch√®que</option>
                        <option value="Virement">üè¶ Virement</option>
                        <option value="Carte cadeau">üéÅ Carte / Bon</option>
                    </select>
                    @if (string.IsNullOrEmpty(_passage.ModePaiement) && _triedSave)
                    {
                        <div class="invalid-feedback">S√©lectionnez un mode de paiement.</div>
                    }
                    <small class="text-muted d-block mt-1">
                        <i class="bi bi-info-circle me-1"></i>¬´ Fractionner ¬ª pour combiner plusieurs moyens.
                    </small>
                }
                else
                {
                    <label class="form-label small fw-semibold">Paiement fractionn√©</label>
                    <small class="text-muted d-block mb-2">R√©partissez le total entre plusieurs moyens de paiement.</small>
                    @for (int i = 0; i < _passage.Paiements.Count; i++)
                    {
                        var idx = i;
                        var pay = _passage.Paiements[idx];
                        <div class="border rounded p-2 mb-2 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label small mb-0 fw-semibold">Paiement @(idx + 1)</label>
                                <button class="btn btn-sm text-danger p-0" @onclick="() => RemovePaiement(idx)"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <div class="row g-2">
                                <div class="col-6">
                                    <select class="form-select form-select-sm" value="@pay.Mode"
                                            @onchange="(e) => OnPaiementModeChanged(idx, e)">
                                        <option value="CB">üí≥ CB</option>
                                        <option value="Esp√®ces">üíµ Esp√®ces</option>
                                        <option value="Ch√®que">üìù Ch√®que</option>
                                        <option value="Virement">üè¶ Virement</option>
                                        <option value="Carte cadeau">üéÅ Carte / Bon</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" @bind="pay.Montant" step="0.01" min="0" placeholder="0.00" />
                                </div>
                            </div>
                            @if (pay.Mode == "Carte cadeau")
                            {
                                <div class="mt-2">
                                    @if (_cartesClient.Count == 0)
                                    {
                                        <div class="alert alert-warning small py-1 px-2 mb-0 mt-1">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            @(string.IsNullOrEmpty(_passage.ClientGuid) ? "S√©lectionnez d'abord un client." : "Aucune carte ou bon actif.")
                                        </div>
                                    }
                                    else
                                    {
                                        <select class="form-select form-select-sm" @bind="pay.CarteCadeauGuid">
                                            <option value="">-- Choisir --</option>
                                            @foreach (var cc in GetCartesDisponiblesPour(idx))
                                            {
                                                <option value="@cc.Guid">@FormatCarteLabel(cc)</option>
                                            }
                                        </select>
                                        @if (GetSelectedPayCarte(pay.CarteCadeauGuid) is CarteCadeau selCarte)
                                        {
                                            <div class="mt-1 p-2 bg-white rounded small">
                                                <i class="bi bi-wallet2 me-1 text-info"></i>Solde disponible : <strong class="text-success">@selCarte.SoldeRestant.ToString("N2") ‚Ç¨</strong>
                                                @if (pay.Montant > selCarte.SoldeRestant)
                                                {
                                                    <br /><span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Montant sup√©rieur au solde !</span>
                                                }
                                                @if (selCarte.Type == "bon_fidelite")
                                                {
                                                    <br /><span class="text-info"><i class="bi bi-info-circle me-1"></i>Utilisable si prestations ‚â• 60 ‚Ç¨</span>
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    }
                    <hr class="my-2" />
                    <div class="d-flex justify-content-between small fw-semibold">
                        <span>Total des paiements :</span>
                        <strong class="@(_totalPaiements != _totalPassage ? "text-danger" : "text-success")">
                            @_totalPaiements.ToString("N2") ‚Ç¨ / @_totalPassage.ToString("N2") ‚Ç¨
                        </strong>
                    </div>
                    @if (Math.Abs(_totalPaiements - _totalPassage) > 0.01m)
                    {
                        <small class="text-danger d-block mt-1">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            @(_totalPaiements < _totalPassage
                                ? $"Il manque {(_totalPassage - _totalPaiements):N2} ‚Ç¨ pour couvrir le total."
                                : $"Les paiements d√©passent le total de {(_totalPaiements - _totalPassage):N2} ‚Ç¨.")
                        </small>
                    }
                }

                @* Carte / Bon (mode simple) *@
                @if (_passage.Paiements.Count == 0 && _passage.ModePaiement == "Carte cadeau")
                {
                    <div class="mt-3">
                        <label class="form-label small fw-semibold">Carte / Bon √† utiliser</label>
                        @if (_cartesClient.Count == 0)
                        {
                            <div class="alert alert-warning small py-1 px-2 mb-0">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                @(string.IsNullOrEmpty(_passage.ClientGuid) ? "S√©lectionnez d'abord un client." : "Aucune carte ou bon actif.")
                            </div>
                        }
                        else
                        {
                            <select class="form-select form-select-sm" @bind="_passage.CarteCadeauGuid">
                                <option value="">-- Choisir --</option>
                                @foreach (var cc in _cartesClient)
                                {
                                    <option value="@cc.Guid">@FormatCarteLabel(cc)</option>
                                }
                            </select>
                            <div class="mt-2">
                                <label class="form-label small fw-semibold">Montant √† utiliser (‚Ç¨)</label>
                                <input type="number" class="form-control form-control-sm" @bind="_passage.MontantCarteUtilisee" step="0.01" min="0" />
                                @if (_selectedCarte != null)
                                {
                                    <div class="mt-1 p-2 bg-light rounded small">
                                        <i class="bi bi-wallet2 me-1 text-info"></i>Solde disponible : <strong class="text-success">@_selectedCarte.SoldeRestant.ToString("N2") ‚Ç¨</strong>
                                        @if (_passage.MontantCarteUtilisee > _selectedCarte.SoldeRestant)
                                        {
                                            <br /><span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Montant sup√©rieur au solde !</span>
                                        }
                                        @if (_selectedCarte.Type == "bon_fidelite")
                                        {
                                            <br /><span class="text-info"><i class="bi bi-info-circle me-1"></i>Utilisable si prestations ‚â• 60 ‚Ç¨</span>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        @* R√©capitulatif *@
        <div class="card border-0 shadow-sm position-sticky" style="top:1rem;">
            <div class="card-header pt-3"><h5 class="mb-0"><i class="bi bi-receipt me-2"></i>R√©capitulatif</h5></div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span><i class="bi bi-scissors me-1 text-gold"></i>Prestations</span>
                    <strong>@_passage.Prestations.Sum(p => p.Prix).ToString("N2") ‚Ç¨</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span><i class="bi bi-bag me-1 text-gold"></i>Produits vendus</span>
                    <strong>@_passage.ProduitsVendus.Sum(p => p.Total).ToString("N2") ‚Ç¨</strong>
                </div>
                @if (_produitsUtilises.Count > 0)
                {
                    <div class="d-flex justify-content-between mb-2 text-muted">
                        <span><i class="bi bi-droplet me-1"></i>Produits utilis√©s</span>
                        <span>@_produitsUtilises.Count produit(s)</span>
                    </div>
                }
                <hr />
                <div class="d-flex justify-content-between mb-3">
                    <span class="fs-5 fw-bold">Total</span>
                    <span class="fs-5 fw-bold text-gold">@_totalPassage.ToString("N2") ‚Ç¨</span>
                </div>

                <button class="btn btn-gold w-100" @onclick="SaveAsync" disabled="@_saving">
                    @if (_saving) { <span class="spinner-border spinner-border-sm me-1"></span> }
                    <i class="bi bi-check-lg me-1"></i> Enregistrer le passage
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string? Guid { get; set; }

    private Passage _passage = new() { Date = DateTime.Now.ToString("dd/MM/yyyy") };
    private List<Client> _clients = [];
    private List<Client> _clientsFiltered = [];
    private List<Prestation> _prestationsCatalogue = [];
    private List<Produit> _produitsCatalogue = [];
    private List<CarteCadeau> _cartesClient = [];
    private List<ProduitUtiliseItem> _produitsUtilises = [];
    private bool _isEdit, _saving, _showClientDropdown, _conflitDetecte, _triedSave;
    private string _alert = "", _alertType = "info";
    private string _clientSearchText = "";
    private CarteCadeau? _fideliteCarte;

    private decimal _totalPassage => _passage.Prestations.Sum(p => p.Prix) + _passage.ProduitsVendus.Sum(p => p.Total);
    private decimal _totalPaiements => _passage.Paiements.Sum(p => p.Montant);
    private CarteCadeau? _selectedCarte => _cartesClient.FirstOrDefault(c => c.Guid == _passage.CarteCadeauGuid);

    // Classe interne pour les produits utilis√©s (non factur√©s)
    private class ProduitUtiliseItem
    {
        public string ProduitId { get; set; } = "";
        public string Nom { get; set; } = "";
        public int Quantite { get; set; } = 1;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsSignedIn || !AuthService.CanWrite) { Nav.NavigateTo("login"); return; }

            _clients = await ClientSvc.GetAllAsync();
            _prestationsCatalogue = await PrestaSvc.GetActivesAsync();
            _produitsCatalogue = await ProduitSvc.GetActifsAsync();

            if (!string.IsNullOrEmpty(Guid))
            {
                _isEdit = true;
                var p = await PassageSvc.GetByGuidAsync(Guid);
                if (p != null)
                {
                    _passage = p;
                    var client = _clients.FirstOrDefault(c => c.Guid == p.ClientGuid);
                    _clientSearchText = client?.NomComplet ?? "";
                    await LoadCartesClient();
                }
                else { Nav.NavigateTo("passages"); return; }
            }
            StateHasChanged();
        }
    }

    private void OnClientSearch(ChangeEventArgs e)
    {
        _clientSearchText = e.Value?.ToString() ?? "";
        _showClientDropdown = true;
        if (string.IsNullOrWhiteSpace(_clientSearchText))
        {
            _clientsFiltered = _clients.Take(20).ToList();
            _passage.ClientGuid = "";
        }
        else
        {
            var t = Client.SupprimerAccents(_clientSearchText.ToLower());
            _clientsFiltered = _clients
                .Where(c => Client.SupprimerAccents(c.NomComplet).Contains(t, StringComparison.OrdinalIgnoreCase)
                    || c.NumeroTelephone.Replace(" ", "").Contains(t.Replace(" ", ""), StringComparison.OrdinalIgnoreCase)
                    || Client.SupprimerAccents(c.Email).Contains(t, StringComparison.OrdinalIgnoreCase))
                .Take(20)
                .ToList();
        }
    }

    private async Task SelectClient(Client c)
    {
        _passage.ClientGuid = c.Guid;
        _clientSearchText = c.NomComplet;
        _showClientDropdown = false;
        await LoadCartesClient();
        StateHasChanged();
    }

    private void ClearClient() { _passage.ClientGuid = ""; _clientSearchText = ""; _cartesClient = []; }

    private async Task LoadCartesClient()
    {
        if (!string.IsNullOrEmpty(_passage.ClientGuid))
        {
            await FideliteSvc.VerifierBonAnniversaireAsync(_passage.ClientGuid);
            var cartes = await CarteSvc.GetByClientAsync(_passage.ClientGuid);
            _cartesClient = cartes.Where(c => c.EstUtilisable).ToList();
        }
        else { _cartesClient = []; }
    }

    private void AddPrestation() => _passage.Prestations.Add(new PassagePrestation());
    private void AddProduitVendu() => _passage.ProduitsVendus.Add(new PassageProduitVendu { Quantite = 1 });
    private void AddProduitConseille() => _passage.ProduitsConseilles.Add(new PassageProduitConseille());
    private void AddProduitUtilise() => _produitsUtilises.Add(new ProduitUtiliseItem());

    private void AddPaiement()
    {
        if (_passage.Paiements.Count == 0 && !string.IsNullOrEmpty(_passage.ModePaiement))
        {
            _passage.Paiements.Add(new PaiementDetail { Mode = _passage.ModePaiement, Montant = _totalPassage });
            _passage.ModePaiement = ""; _passage.CarteCadeauGuid = ""; _passage.MontantCarteUtilisee = 0;
        }
        else
        {
            var restant = _totalPassage - _totalPaiements;
            _passage.Paiements.Add(new PaiementDetail { Mode = "CB", Montant = Math.Max(0, restant) });
        }
    }

    private void RemovePaiement(int idx)
    {
        if (idx >= 0 && idx < _passage.Paiements.Count) _passage.Paiements.RemoveAt(idx);
        if (_passage.Paiements.Count == 0) _passage.ModePaiement = "";
    }

    private void OnPaiementModeChanged(int idx, ChangeEventArgs e)
    {
        var mode = e.Value?.ToString() ?? "CB";
        if (idx < _passage.Paiements.Count)
        {
            _passage.Paiements[idx].Mode = mode;
            if (mode != "Carte cadeau") _passage.Paiements[idx].CarteCadeauGuid = "";
        }
    }

    private static string FormatCarteLabel(CarteCadeau cc)
    {
        var icon = cc.Type switch { "fidelite" => "Fid√©lit√©", "bon_fidelite" => "Bon Anniv.", _ => "Carte cadeau" };
        return $"{icon} : {cc.SoldeRestant:N2}‚Ç¨ restant ‚Äî {(string.IsNullOrEmpty(cc.Origine) ? "Sans description" : cc.Origine)}";
    }

    private CarteCadeau? GetSelectedPayCarte(string? carteGuid)
        => string.IsNullOrEmpty(carteGuid) ? null : _cartesClient.FirstOrDefault(c => c.Guid == carteGuid);

    private List<CarteCadeau> GetCartesDisponiblesPour(int slotIdx)
    {
        var cartesUtilisees = _passage.Paiements
            .Where((p, i) => i != slotIdx && p.Mode == "Carte cadeau" && !string.IsNullOrEmpty(p.CarteCadeauGuid))
            .Select(p => p.CarteCadeauGuid).ToHashSet();
        return _cartesClient.Where(c => !cartesUtilisees.Contains(c.Guid) || c.Guid == (_passage.Paiements.ElementAtOrDefault(slotIdx)?.CarteCadeauGuid ?? "")).ToList();
    }

    private void OnPrestationSelected(int idx, ChangeEventArgs e)
    {
        var guid = e.Value?.ToString() ?? "";
        var cat = _prestationsCatalogue.FirstOrDefault(p => p.Guid == guid);
        if (cat != null && idx < _passage.Prestations.Count)
        {
            _passage.Prestations[idx].PrestationId = cat.Guid;
            _passage.Prestations[idx].Nom = cat.Nom;
            _passage.Prestations[idx].Prix = cat.PrixDefaut;
            _passage.Prestations[idx].DureeMinutes = cat.DureeMinutes;
        }
    }

    private void OnProduitVenduSelected(int idx, ChangeEventArgs e)
    {
        var guid = e.Value?.ToString() ?? "";
        var prod = _produitsCatalogue.FirstOrDefault(p => p.Guid == guid);
        if (prod != null && idx < _passage.ProduitsVendus.Count)
        {
            _passage.ProduitsVendus[idx].ProduitId = prod.Guid;
            _passage.ProduitsVendus[idx].Nom = prod.Nom;
            _passage.ProduitsVendus[idx].PrixUnitaire = prod.PrixVente;
        }
    }

    private void OnProduitUtiliseSelected(int idx, ChangeEventArgs e)
    {
        var guid = e.Value?.ToString() ?? "";
        var prod = _produitsCatalogue.FirstOrDefault(p => p.Guid == guid);
        if (prod != null && idx < _produitsUtilises.Count)
        {
            _produitsUtilises[idx].ProduitId = prod.Guid;
            _produitsUtilises[idx].Nom = prod.Nom;
        }
    }

    private void OnProduitConseilleSelected(int idx, ChangeEventArgs e)
    {
        var guid = e.Value?.ToString() ?? "";
        if (string.IsNullOrEmpty(guid))
        {
            if (idx < _passage.ProduitsConseilles.Count) { _passage.ProduitsConseilles[idx].ProduitId = ""; _passage.ProduitsConseilles[idx].Nom = ""; }
        }
        else
        {
            var prod = _produitsCatalogue.FirstOrDefault(p => p.Guid == guid);
            if (prod != null && idx < _passage.ProduitsConseilles.Count)
            { _passage.ProduitsConseilles[idx].ProduitId = prod.Guid; _passage.ProduitsConseilles[idx].Nom = prod.Nom; _passage.ProduitsConseilles[idx].PrixIndicatif = prod.PrixVente; }
        }
    }

    private async Task SaveAsync() => await DoSaveAsync(false);
    private async Task ForcerSauvegarde() => await DoSaveAsync(true);

    private async Task DoSaveAsync(bool forceWrite)
    {
        _triedSave = true; _alert = ""; StateHasChanged();

        // ‚îÄ‚îÄ Validations compl√®tes ‚îÄ‚îÄ
        var errors = new List<string>();

        if (string.IsNullOrEmpty(_passage.ClientGuid))
            errors.Add("S√©lectionnez un client dans la liste.");

        if (string.IsNullOrEmpty(_passage.Date))
            errors.Add("La date est requise.");
        else if (!DateTime.TryParseExact(_passage.Date, new[] { "dd/MM/yyyy" },
            System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out _))
            errors.Add("Format de date invalide (attendu : JJ/MM/AAAA).");

        if (_passage.Prestations.Count == 0 && _passage.ProduitsVendus.Count == 0)
            errors.Add("Ajoutez au moins une prestation ou un produit vendu.");

        // V√©rifier que les prestations sont bien s√©lectionn√©es
        foreach (var pp in _passage.Prestations)
        {
            if (string.IsNullOrEmpty(pp.PrestationId))
                errors.Add("Chaque prestation doit √™tre s√©lectionn√©e dans le catalogue.");
            if (pp.Prix < 0) errors.Add($"Le prix de ¬´ {pp.Nom} ¬ª ne peut pas √™tre n√©gatif.");
        }

        // V√©rifier stock des produits vendus
        foreach (var pv in _passage.ProduitsVendus)
        {
            if (string.IsNullOrEmpty(pv.ProduitId)) { errors.Add("Chaque produit vendu doit √™tre s√©lectionn√©."); continue; }
            if (pv.Quantite <= 0) { errors.Add($"La quantit√© de ¬´ {pv.Nom} ¬ª doit √™tre sup√©rieure √† 0."); continue; }
            var stock = _produitsCatalogue.FirstOrDefault(p => p.Guid == pv.ProduitId);
            if (stock != null && pv.Quantite > stock.Stock)
                errors.Add($"Stock insuffisant pour ¬´ {pv.Nom} ¬ª ({stock.Stock} disponible(s), {pv.Quantite} demand√©(s)).");
        }

        // V√©rifier stock des produits utilis√©s
        foreach (var pu in _produitsUtilises)
        {
            if (string.IsNullOrEmpty(pu.ProduitId)) continue;
            if (pu.Quantite <= 0) { errors.Add($"La quantit√© de ¬´ {pu.Nom} ¬ª (produit utilis√©) doit √™tre > 0."); continue; }
            var stock = _produitsCatalogue.FirstOrDefault(p => p.Guid == pu.ProduitId);
            if (stock != null && pu.Quantite > stock.Stock)
                errors.Add($"Stock insuffisant pour ¬´ {pu.Nom} ¬ª (utilis√©) ({stock.Stock} dispo, {pu.Quantite} demand√©).");
        }

        // V√©rifier le paiement
        if (_passage.Paiements.Count > 0)
        {
            var diff = Math.Abs(_totalPaiements - _totalPassage);
            if (diff > 0.01m)
                errors.Add($"Le total des paiements ({_totalPaiements:N2}‚Ç¨) ne correspond pas au total ({_totalPassage:N2}‚Ç¨).");

            foreach (var pay in _passage.Paiements)
            {
                if (pay.Montant <= 0) errors.Add("Chaque paiement doit avoir un montant > 0.");
                if (pay.Mode == "Carte cadeau")
                {
                    if (string.IsNullOrEmpty(pay.CarteCadeauGuid))
                        errors.Add("S√©lectionnez une carte/bon pour chaque paiement par carte.");
                    else
                    {
                        var carte = _cartesClient.FirstOrDefault(c => c.Guid == pay.CarteCadeauGuid);
                        if (carte != null && pay.Montant > carte.SoldeRestant)
                            errors.Add($"Le montant ({pay.Montant:N2}‚Ç¨) d√©passe le solde de la carte ({carte.SoldeRestant:N2}‚Ç¨).");
                    }
                }
            }
        }
        else
        {
            if (string.IsNullOrEmpty(_passage.ModePaiement))
                errors.Add("S√©lectionnez un mode de paiement.");
            if (_passage.ModePaiement == "Carte cadeau")
            {
                if (string.IsNullOrEmpty(_passage.CarteCadeauGuid))
                    errors.Add("S√©lectionnez une carte/bon √† utiliser.");
                else if (_selectedCarte != null && _passage.MontantCarteUtilisee > _selectedCarte.SoldeRestant)
                    errors.Add($"Le montant ({_passage.MontantCarteUtilisee:N2}‚Ç¨) d√©passe le solde ({_selectedCarte.SoldeRestant:N2}‚Ç¨).");
                if (_passage.MontantCarteUtilisee <= 0)
                    errors.Add("Indiquez le montant √† utiliser sur la carte.");
            }
        }

        // V√©rifier bon anniversaire (>= 60‚Ç¨ de prestations)
        var totalPrestations = _passage.Prestations.Sum(p => p.Prix);
        var cartesPaiementBonAnniv = _passage.Paiements.Count > 0
            ? _passage.Paiements.Where(p => p.Mode == "Carte cadeau" && !string.IsNullOrEmpty(p.CarteCadeauGuid))
                .Select(p => _cartesClient.FirstOrDefault(c => c.Guid == p.CarteCadeauGuid))
                .Where(c => c?.Type == "bon_fidelite")
            : (_selectedCarte?.Type == "bon_fidelite" ? new[] { _selectedCarte } : Array.Empty<CarteCadeau?>());

        if (cartesPaiementBonAnniv.Any() && totalPrestations < 60m)
            errors.Add("Le bon anniversaire n'est utilisable que si le total des prestations est ‚â• 60 ‚Ç¨.");

        if (errors.Count > 0)
        {
            _alert = string.Join("\n‚Ä¢ ", errors.Prepend("Veuillez corriger les erreurs suivantes :"));
            _alertType = "warning";
            return;
        }

        // ‚îÄ‚îÄ Sauvegarde ‚îÄ‚îÄ
        if (_passage.Paiements.Count > 0)
            _passage.ModePaiement = string.Join(" + ", _passage.Paiements.Select(p => p.Mode).Distinct());

        _saving = true; _conflitDetecte = false; StateHasChanged();
        try
        {
            _passage.RecalculerTotal();

            if (_isEdit)
            {
                var success = await PassageSvc.UpdateAsync(_passage, forceWrite);
                if (!success) { _conflitDetecte = true; _saving = false; StateHasChanged(); return; }
            }
            else
            {
                await PassageSvc.AddAsync(_passage);
            }

            // Mouvements de stock ‚Äî produits vendus
            foreach (var pv in _passage.ProduitsVendus)
            {
                if (!string.IsNullOrEmpty(pv.ProduitId))
                    await MouvementSvc.EnregistrerSortieAsync(pv.ProduitId, pv.Quantite, pv.PrixUnitaire, _passage.Guid);
            }

            // Mouvements de stock ‚Äî produits utilis√©s (non factur√©s)
            foreach (var pu in _produitsUtilises)
            {
                if (!string.IsNullOrEmpty(pu.ProduitId) && pu.Quantite > 0)
                    await MouvementSvc.EnregistrerSortieAsync(pu.ProduitId, pu.Quantite, 0, _passage.Guid);
            }

            // Utiliser les cartes cadeaux / bons fid√©lit√©
            if (_passage.Paiements.Count > 0)
            {
                foreach (var pay in _passage.Paiements.Where(p => p.Mode == "Carte cadeau" && !string.IsNullOrEmpty(p.CarteCadeauGuid)))
                    await CarteSvc.UtiliserAsync(pay.CarteCadeauGuid, pay.Montant);
            }
            else if (!string.IsNullOrEmpty(_passage.CarteCadeauGuid) && _passage.MontantCarteUtilisee > 0)
            {
                await CarteSvc.UtiliserAsync(_passage.CarteCadeauGuid, _passage.MontantCarteUtilisee);
            }

            // V√©rifier fid√©lit√© (10 passages ‚Üí carte fid√©lit√© automatique)
            _fideliteCarte = await FideliteSvc.VerifierEtGenererAsync(_passage.ClientGuid);

            if (_fideliteCarte != null)
            {
                Toast.ShowSuccess($"Carte fid√©lit√© g√©n√©r√©e : {_fideliteCarte.MontantInitial:N2} ‚Ç¨ !");
                StateHasChanged();
            }
            else
            {
                Toast.ShowSuccess("Passage enregistr√© avec succ√®s.");
                Nav.NavigateTo("passages");
            }
        }
        catch (Exception ex) { Toast.ShowError(ex.Message); }
        finally { _saving = false; StateHasChanged(); }
    }

    private async Task GoBack() => await JSRuntime.InvokeVoidAsync("navigateBack");

    private async Task RechargerDonnees()
    {
        if (!string.IsNullOrEmpty(Guid))
        {
            var p = await PassageSvc.GetByGuidAsync(Guid);
            if (p != null) _passage = p;
            _conflitDetecte = false;
            StateHasChanged();
        }
    }
}
