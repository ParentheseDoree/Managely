@page "/clients/{Guid}"
@inject ClientService ClientSvc
@inject PassageService PassageSvc
@inject CarteCadeauService CarteSvc
@inject FideliteService FideliteSvc
@inject GoogleAuthService AuthService
@inject ToastService Toast
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<PageTitle>@(_client?.NomComplet ?? "Client") - Managely</PageTitle>

@if (_loading)
{
    <LoadingSpinner Message="Chargement du profil..." />
}
else if (_client == null)
{
    <div class="alert alert-warning">Client introuvable.</div>
}
else
{
    <div class="page-header">
        <div>
            <h1><i class="bi bi-person me-2"></i>@_client.NomComplet</h1>
            <p>Fiche client détaillée</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            @if (AuthService.CanWrite)
            {
                <button class="btn btn-gold" @onclick='() => Nav.NavigateTo($"clients/{Guid}/modifier")'>
                    <i class="bi bi-pencil me-1"></i> Modifier
                </button>
                <button class="btn btn-outline-success" @onclick='() => Nav.NavigateTo($"passages/nouveau")'>
                    <i class="bi bi-plus-circle me-1"></i> Nouveau passage
                </button>
                <button class="btn btn-outline-info" @onclick='() => Nav.NavigateTo("cartes-cadeaux")'>
                    <i class="bi bi-gift me-1"></i> Carte cadeau
                </button>
            }
            <button class="btn btn-outline-secondary" @onclick="GoBack">
                <i class="bi bi-arrow-left me-1"></i> Retour
            </button>
        </div>
    </div>

    <div class="row g-4">
        @* Informations *@
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title mb-3"><i class="bi bi-person-vcard me-2 text-gold"></i>Informations</h5>
                    <dl class="mb-0">
                        <dt class="small text-muted">Téléphone</dt>
                        <dd>
                            @if (!string.IsNullOrEmpty(_client.NumeroTelephone))
                            {
                                <a href="tel:@_client.NumeroTelephone.Replace(" ", "")" class="text-decoration-none">
                                    <i class="bi bi-telephone me-1"></i>@_client.NumeroTelephone
                                </a>
                            }
                            else { <span>—</span> }
                        </dd>
                        <dt class="small text-muted">Email</dt>
                        <dd>@(string.IsNullOrEmpty(_client.Email) ? "—" : _client.Email)</dd>
                        <dt class="small text-muted">Adresse</dt>
                        <dd>@(string.IsNullOrEmpty(_client.Adresse) ? "—" : _client.Adresse)</dd>
                        <dt class="small text-muted">Anniversaire</dt>
                        <dd>@(string.IsNullOrEmpty(_client.MoisAnniversaire) ? "—" : _client.MoisAnniversaire)</dd>
                        <dt class="small text-muted">Client depuis</dt>
                        <dd>@FormatDate(_client.DateCreation)</dd>
                        @if (!string.IsNullOrEmpty(_client.DateModification))
                        {
                            <dt class="small text-muted">Dernière modification</dt>
                            <dd>@FormatDate(_client.DateModification)</dd>
                        }
                    </dl>
                </div>
            </div>
        </div>

        @* Statistiques *@
        <div class="col-lg-8">
            <div class="row g-3 mb-4">
                <div class="col-6">
                    <StatCard Value="@_nbPassages.ToString()" Label="Passages" Icon="bi-calendar-check" Color="primary" />
                </div>
                <div class="col-6">
                    <StatCard Value="@($"{_passagesAvant} restant(s)")" Label="Prochain palier fidélité"
                              Icon="bi-heart" Color="warning" />
                </div>
            </div>

            @* Cartes et bons *@
            @if (_cartes.Count > 0)
            {
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header pt-3">
                        <h6 class="mb-0"><i class="bi bi-gift me-2 text-gold"></i>Cartes & Bons (@_cartes.Count)</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead><tr><th>Type</th><th>Montant</th><th>Solde</th><th>Statut</th><th>Expiration</th></tr></thead>
                                <tbody>
                                    @foreach (var c in _cartes)
                                    {
                                        <tr>
                                            <td>
                                                <span class="badge @GetTypeBadgeClass(c.Type)">
                                                    @GetTypeLabel(c.Type)
                                                </span>
                                            </td>
                                            <td>@c.MontantInitial.ToString("N2") €</td>
                                            <td><strong>@c.SoldeRestant.ToString("N2") €</strong></td>
                                            <td>
                                                <span class="badge @(c.StatutCalcule switch { "active" => "bg-success", "utilisee" => "bg-secondary", _ => "bg-danger" })">
                                                    @c.StatutCalcule
                                                </span>
                                            </td>
                                            <td>@(string.IsNullOrEmpty(c.DateExpiration) ? "—" : c.DateExpiration)</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    @* Historique des passages *@
    <div class="card border-0 shadow-sm mt-4">
        <div class="card-header pt-3">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2 text-gold"></i>Historique des passages (@_passages.Count)</h5>
        </div>
        @if (_passages.Count == 0)
        {
            <div class="card-body text-muted">Aucun passage enregistré.</div>
        }
        else
        {
            @* Vue mobile *@
            <div class="card-body d-md-none">
                @foreach (var p in _passages)
                {
                    <div class="border rounded p-3 mb-2 cursor-pointer" @onclick='() => Nav.NavigateTo($"passages/{p.Guid}")'>
                        <div class="d-flex justify-content-between mb-1">
                            <strong>@p.Date</strong>
                            <span class="text-gold fw-bold">@p.Total.ToString("N2") €</span>
                        </div>
                        <div class="small text-muted">@p.ResumePrestations</div>
                    </div>
                }
            </div>
            @* Vue desktop *@
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover mb-0">
                    <thead><tr><th>Date</th><th>Prestations</th><th class="text-end">Total</th><th>Paiement</th></tr></thead>
                    <tbody>
                        @foreach (var p in _passages)
                        {
                            <tr class="cursor-pointer" @onclick='() => Nav.NavigateTo($"passages/{p.Guid}")'>
                                <td>@p.Date</td>
                                <td>@p.ResumePrestations</td>
                                <td class="text-end"><strong>@p.Total.ToString("N2") €</strong></td>
                                <td>@(string.IsNullOrEmpty(p.ModePaiement) ? "—" : p.ModePaiement)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    @* Historique des produits achetés *@
    @if (_produitsAchetes.Count > 0)
    {
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header pt-3">
                <h5 class="mb-0"><i class="bi bi-bag-check me-2 text-gold"></i>Produits achetés (@_produitsAchetes.Count)</h5>
            </div>
            <div class="card-body d-md-none">
                @foreach (var pa in _produitsAchetes)
                {
                    <div class="border rounded p-3 mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <strong>@pa.Nom</strong>
                            <span class="text-gold fw-bold">@pa.Total.ToString("N2") €</span>
                        </div>
                        <div class="small text-muted">@pa.Date — @pa.Quantite x @pa.PrixUnitaire.ToString("N2") €</div>
                    </div>
                }
            </div>
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover mb-0">
                    <thead><tr><th>Date</th><th>Produit</th><th class="text-center">Qté</th><th class="text-end">Prix unit.</th><th class="text-end">Total</th></tr></thead>
                    <tbody>
                        @foreach (var pa in _produitsAchetes)
                        {
                            <tr>
                                <td>@pa.Date</td>
                                <td><strong>@pa.Nom</strong></td>
                                <td class="text-center">@pa.Quantite</td>
                                <td class="text-end">@pa.PrixUnitaire.ToString("N2") €</td>
                                <td class="text-end fw-bold">@pa.Total.ToString("N2") €</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@code {
    [Parameter] public string Guid { get; set; } = "";

    private Client? _client;
    private List<Passage> _passages = [];
    private List<CarteCadeau> _cartes = [];
    private List<ProduitAcheteDetail> _produitsAchetes = [];
    private bool _loading = true;
    private int _nbPassages;
    private int _passagesAvant;

    private async Task GoBack() => await JSRuntime.InvokeVoidAsync("navigateBack");

    private static string FormatDate(string dateStr)
    {
        if (string.IsNullOrEmpty(dateStr)) return "—";
        if (DateTime.TryParse(dateStr, out var d))
            return d.ToString("dd/MM/yyyy à HH:mm");
        return dateStr;
    }

    private static string GetTypeBadgeClass(string type) => type switch
    {
        "fidelite" => "bg-warning text-dark",
        "bon_fidelite" => "bg-info",
        "achat" => "bg-primary",
        _ => "bg-secondary"
    };

    private static string GetTypeLabel(string type) => type switch
    {
        "fidelite" => "Fidélité",
        "bon_fidelite" => "Bon anniversaire",
        "achat" => "Carte cadeau",
        _ => type
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsSignedIn || !AuthService.CanRead)
            { Nav.NavigateTo("login"); return; }

            _client = await ClientSvc.GetByGuidAsync(Guid);
            if (_client != null)
            {
                _passages = await PassageSvc.GetByClientAsync(Guid);
                _cartes = await CarteSvc.GetByClientAsync(Guid);
                var (nb, avant, _) = await FideliteSvc.GetStatutAsync(Guid);
                _nbPassages = nb;
                _passagesAvant = avant;

                _produitsAchetes = _passages
                    .SelectMany(p => p.ProduitsVendus.Select(pv => new ProduitAcheteDetail
                    {
                        Date = p.Date,
                        Nom = pv.Nom,
                        Quantite = pv.Quantite,
                        PrixUnitaire = pv.PrixUnitaire,
                        Total = pv.Total,
                        PassageGuid = p.Guid
                    }))
                    .OrderByDescending(pa => pa.Date)
                    .ToList();
            }
            _loading = false;
            StateHasChanged();
        }
    }

    private class ProduitAcheteDetail
    {
        public string Date { get; set; } = "";
        public string Nom { get; set; } = "";
        public int Quantite { get; set; }
        public decimal PrixUnitaire { get; set; }
        public decimal Total { get; set; }
        public string PassageGuid { get; set; } = "";
    }
}
