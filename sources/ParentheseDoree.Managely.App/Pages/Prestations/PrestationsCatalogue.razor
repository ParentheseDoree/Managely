@page "/prestations"
@inject PrestationService PrestaSvc
@inject GoogleAuthService AuthService
@inject ToastService Toast
@inject NavigationManager Nav

<PageTitle>Prestations - Managely</PageTitle>

<div class="page-header">
    <div>
        <h1><i class="bi bi-scissors me-2"></i>Catalogue de prestations</h1>
        <p>Types de soins proposés</p>
    </div>
    @if (AuthService.CanWrite)
    {
        <button class="btn btn-gold" @onclick="ShowAdd">
            <i class="bi bi-plus-lg me-1"></i> Nouvelle prestation
        </button>
    }
</div>

@if (_loading)
{
    <LoadingSpinner />
}
else if (_all.Count == 0)
{
    <div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>Aucune prestation dans le catalogue. Commencez par en ajouter une !</div>
}
else
{
    <div class="row g-3">
        @foreach (var cat in _grouped)
        {
            <div class="col-12">
                <h5 class="text-muted mb-3">
                    <i class="bi bi-tag me-1"></i>@(string.IsNullOrEmpty(cat.Key) ? "Sans catégorie" : cat.Key)
                    <span class="badge bg-light text-dark ms-1">@cat.Count()</span>
                </h5>
            </div>
            @foreach (var p in cat)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="fw-bold mb-2">@p.Nom</h6>
                                    <span class="badge bg-gold-subtle text-gold fs-6">@p.PrixDefaut.ToString("N0") €</span>
                                    @if (p.DureeMinutes > 0)
                                    {
                                        <span class="badge bg-light text-dark ms-1"><i class="bi bi-clock me-1"></i>@p.DureeMinutes min</span>
                                    }
                                </div>
                                @if (!p.Actif)
                                {
                                    <span class="badge bg-secondary">Inactif</span>
                                }
                            </div>
                        </div>
                        @if (AuthService.CanWrite)
                        {
                            <div class="card-footer bg-transparent border-0 d-flex gap-2">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ShowEdit(p)" title="Modifier">
                                    <i class="bi bi-pencil me-1"></i>Modifier
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(p)" title="Supprimer">
                                    <i class="bi bi-trash me-1"></i>Supprimer
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
}

@* Modal ajout/modification *@
@if (_showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color:rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-scissors me-2"></i>@(_editing.RowIndex == 0 ? "Nouvelle prestation" : "Modifier la prestation")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <AlertMessage Message="@_alert" Type="@_alertType" OnDismiss="() => _alert = string.Empty" />
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-semibold">Nom <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" @bind="_editing.Nom" placeholder="Ex: Soin visage hydratant" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Catégorie</label>
                            <input type="text" class="form-control" @bind="_editing.Categorie" placeholder="Ex: Soins visage" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Prix (€) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" @bind="_editing.PrixDefaut" step="0.01" min="0" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Durée (min)</label>
                            <input type="number" class="form-control" @bind="_editing.DureeMinutes" min="0" />
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" @bind="_editing.Actif" />
                                <label class="form-check-label">Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">Annuler</button>
                    <button class="btn btn-gold" @onclick="SaveAsync" disabled="@_saving">
                        @if (_saving) { <span class="spinner-border spinner-border-sm me-1"></span> }
                        <i class="bi bi-check-lg me-1"></i>Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<ConfirmModal IsVisible="_showDelete" Title="Supprimer la prestation"
              TitleCss="text-danger" Icon="bi-exclamation-triangle"
              ConfirmText="Supprimer" IsProcessing="_deleting"
              OnConfirm="DeleteAsync" OnCancel="() => _showDelete = false">
    <p>Supprimer <strong>@_toDelete?.Nom</strong> ?</p>
</ConfirmModal>

@code {
    private List<Prestation> _all = [];
    private IEnumerable<IGrouping<string, Prestation>> _grouped = [];
    private bool _loading = true;
    private bool _showModal, _saving, _showDelete, _deleting;
    private Prestation _editing = new();
    private Prestation? _toDelete;
    private string _alert = "", _alertType = "info";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AuthService.InitializeAsync();
            if (!AuthService.IsSignedIn || !AuthService.CanRead) { Nav.NavigateTo("login"); return; }
            await LoadAsync();
        }
    }

    private async Task LoadAsync()
    {
        _loading = true; StateHasChanged();
        try { _all = await PrestaSvc.GetAllAsync(true); _grouped = _all.GroupBy(p => p.Categorie).OrderBy(g => g.Key); }
        catch (Exception ex) { Toast.ShowError(ex.Message); }
        finally { _loading = false; StateHasChanged(); }
    }

    private void ShowAdd() { _editing = new Prestation { Actif = true }; _showModal = true; _alert = ""; }
    private void ShowEdit(Prestation p)
    {
        _editing = new Prestation { RowIndex = p.RowIndex, Guid = p.Guid, Nom = p.Nom, Categorie = p.Categorie, PrixDefaut = p.PrixDefaut, DureeMinutes = p.DureeMinutes, Actif = p.Actif };
        _showModal = true; _alert = "";
    }
    private void CloseModal() { _showModal = false; _editing = new(); }
    private void ConfirmDelete(Prestation p) { _toDelete = p; _showDelete = true; }

    private async Task SaveAsync()
    {
        if (string.IsNullOrWhiteSpace(_editing.Nom)) { _alert = "Le nom est requis."; _alertType = "warning"; return; }
        _saving = true; StateHasChanged();
        try
        {
            if (_editing.RowIndex == 0) await PrestaSvc.AddAsync(_editing);
            else await PrestaSvc.UpdateAsync(_editing);
            CloseModal(); await LoadAsync();
            Toast.ShowSuccess("Prestation enregistrée.");
        }
        catch (Exception ex) { Toast.ShowError(ex.Message); }
        finally { _saving = false; StateHasChanged(); }
    }

    private async Task DeleteAsync()
    {
        if (_toDelete == null) return;
        _deleting = true; StateHasChanged();
        try
        {
            await PrestaSvc.DeleteAsync(_toDelete.RowIndex);
            _showDelete = false; _toDelete = null; await LoadAsync();
            Toast.ShowSuccess("Prestation supprimée.");
        }
        catch (Exception ex) { Toast.ShowError(ex.Message); }
        finally { _deleting = false; StateHasChanged(); }
    }
}
