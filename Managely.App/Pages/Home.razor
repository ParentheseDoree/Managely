@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Managely.App.Services
@attribute [Authorize]
@inject SpreadsheetAccessService SpreadsheetService
@inject NavigationManager Navigation

<PageTitle>Accueil - Managely</PageTitle>

<!-- Overlay de vérification d'accès -->
@if (IsCheckingAccess)
{
    <div class="access-check-overlay">
        <div class="access-check-card">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Vérification...</span>
            </div>
            <h5 class="mb-2">Vérification des droits d'accès</h5>
            <p class="text-muted mb-0">Veuillez patienter...</p>
        </div>
    </div>
}

<div class="home-page">
    <div class="container py-4">
        <!-- Carte de bienvenue -->
        <div class="welcome-card mb-4">
            <div class="row align-items-center">
                <div class="col-12 col-md-8">
                    <h1 class="h3 fw-bold mb-2">
                        <i class="bi bi-hand-wave me-2"></i>
                        Bienvenue sur Managely !
                    </h1>
                    <p class="mb-0 opacity-90">
                        Vous êtes connecté avec succès. Vous pouvez maintenant accéder à toutes les fonctionnalités.
                    </p>
                </div>
                <div class="col-12 col-md-4 text-md-end mt-3 mt-md-0">
                    <AuthorizeView>
                        <Authorized>
                            @{
                                var email = context.User.FindFirst("email")?.Value ?? context.User.Identity?.Name;
                            }
                            <span class="badge bg-white text-dark px-3 py-2 rounded-pill">
                                <i class="bi bi-check-circle-fill text-success me-1"></i>
                                @email
                            </span>
                        </Authorized>
                    </AuthorizeView>
                </div>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="row g-4">
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-primary bg-opacity-10 p-3 rounded-3 me-3">
                                <i class="bi bi-table text-primary fs-4"></i>
                            </div>
                            <h5 class="card-title mb-0">Données</h5>
                        </div>
                        <p class="card-text text-muted">
                            Accédez à vos données Google Spreadsheet en toute sécurité.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-success bg-opacity-10 p-3 rounded-3 me-3">
                                <i class="bi bi-shield-check text-success fs-4"></i>
                            </div>
                            <h5 class="card-title mb-0">Sécurité</h5>
                        </div>
                        <p class="card-text text-muted">
                            Authentification sécurisée via votre compte Google.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-warning bg-opacity-10 p-3 rounded-3 me-3">
                                <i class="bi bi-lightning-charge text-warning fs-4"></i>
                            </div>
                            <h5 class="card-title mb-0">Performance</h5>
                        </div>
                        <p class="card-text text-muted">
                            Application optimisée pour une expérience fluide.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool IsCheckingAccess { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        await CheckSpreadsheetAccessAsync();
    }

    private async Task CheckSpreadsheetAccessAsync()
    {
        try
        {
            var result = await SpreadsheetService.CheckAccessAsync();
            
            if (!result.HasAccess)
            {
                // Déconnecter l'utilisateur et rediriger vers la page de connexion avec un message d'erreur
                var errorMessage = Uri.EscapeDataString(result.ErrorMessage ?? "Accès refusé");
                Navigation.NavigateToLogout("authentication/logout", $"login?Error={errorMessage}");
            }
        }
        catch
        {
            // En cas d'erreur, on laisse l'accès (la vérification sera refaite lors d'appels API)
        }
        finally
        {
            IsCheckingAccess = false;
            StateHasChanged();
        }
    }
}
